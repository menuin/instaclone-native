# ğŸ³ DEVLOG 8/6

### #18.1 Rooms Screen part 1

- ì¿¼ë¦¬ ì‘ì„±(fragmentì´ìš©),  rooms screen ë§Œë“¤ê¸° (screenLayout, flatList) : ì½”ë“œ ì°¸ê³ 

```js
<FlatList
    data={data?.seeRooms} // dataëŠ” arrayí˜•ì‹ì´ì–´ì•¼ í•˜ê¸°ë•Œë¬¸ì— data.seeRooms ë¥¼ ë„£ìŒ
    keyExtractor={room => "" + room.id}
    renderItem={renderItem}
/>
```



### #18.2 Rooms Screen part 2

- Rooms ìŠ¤íƒ€ì¼ë§

- ìƒëŒ€ username ì•Œì•„ë‚´ê¸° : useMe hook ì‚¬ìš©

```js
const {data : meData} = useMe();
const renderItem = ({ item: room }) => {
        const notMe = room.users.find(
            (user) => user.username !== meData?.me?.username
        )
```

- unreadDot >> ì•ˆì½ì€ ë©”ì„¸ì§€ê°€ ìˆì„ë•Œë§Œ

- ìƒˆë¡œê³ ì¹¨, ìŠ¤í¬ë¡¤ >> ì•Œì•„ì„œ í•´ë³´ê¸°



### #18.3 Room Screen part 1

- Roomsë¥¼ ìŠ¤í¬ë¦°ì—ì„œ ë¶„ë¦¬ : ì»´í¬ë„ŒíŠ¸ë¡œ ë§Œë“¤ê¸°(components/rooms/RoomItem.js)

```js
// Rooms.js
const renderItem = ({ item: room }) => (
        <RoomItem {...room} />
    );
```

- rooms -> room navigation

```js
const goToRoom = () => navigation.navigate("Room", {
        id,
        talkingTo,
    });
```

- Room.js ì‘ì„± (seeRoom ì¿¼ë¦¬)



### #18.4 Room Screen part 2

- room screen layout

- FlatList inverted : ì •ë ¬ ë°©í–¥ ë°˜ëŒ€ë¡œ(ì—¬ê¸°ì„  í•„ìš”x)

```js
<FlatList
                inverted
            />
```

- (ë©”ì„¸ì§€ ì‘ì„±) input
  - í‚¤ë³´ë“œê°€ ì˜¬ë¼ê°”ì„ ë•Œ ë‹¤ ìœ„ë¡œ ê°™ì´ ì˜¬ë¦¬ê¸° : ì „ë¶€ keyboard avoiding view ì•ˆì— ë„£ê¸°

```js
<KeyboardAvoidingView style={{ flex: 1, }} behavior="padding" keyboardVerticalOffset={160}>
```

- `behavior="height"` : ë“¤ë ¤ì˜¬ë¼ê°„ ë§Œí¼ ë¹ˆê³µê°„ë¨ (í•˜ì–€ìƒ‰ ë°°ê²½)



### #18.5 Room Screen part 3

- ë§í’ì„  ìŠ¤íƒ€ì¼ë§ 
- border-radius ì•ˆë¨¹ìœ¼ë©´ overflow : hidden ì¶”ê°€ (ìì‹íƒœê·¸ê°€ ë¶€ëª¨íƒœê·¸ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ì˜¤ëŠ” ì˜¤ë¥˜)



- ë“¤ì–´ì˜¤ëŠ” ë©”ì„¸ì§€ëŠ” ì™¼ìª½ì—, ë‚˜ê°€ëŠ” ë©”ì„¸ì§€ëŠ” ì˜¤ë¥¸ìª½ì—

  - `flex-direction : row-reverse` 
  - êµ¬ë³„í•˜ê¸° : messageContainerì— prop ì£¼ê¸°

  ```js
  <MessageContainer outgoing={message.user.username !== route?.params?.talkingTo?.username} >
  ```

  ```js
  const MessageContainer = styled.View`
      flex-direction: ${props => props.outgoing ? "row-reverse" : "row"};
  `;
  ```



- mutation ì‘ì„±: sendMessage



### #18.6 Room Screen part 4

- form (for sending messages)

```js
const { register, setValue, handleSubmit } = useForm();
const onValid = ({ message }) => {
        alert("will send", message);
    }
useEffect(() => {
    register("message", { required: true })
}, [register]);

...
<MessageInput
    onChangeText={(text) => setValue("message", text)}
    // registerí•œê±°ë‘ ê°™ì€ ì´ë¦„ìœ¼ë¡œ
    onSubmitEditing={handleSubmit(onValid)}
/>
```

- mutation ì‹¤í–‰ì€ onValid ì•ˆì—ì„œ

```js
    const onValid = ({ message }) => {
        sendMessageMutation({
            variables: {
                payload: message,
                roomId: route?.params?.id,
            }
        })
    }
```

ğŸ’¦ unhandled promise rejection í‘í‘ ì´ ì˜¤ë¥˜ê°€ ì œì¼ ì‹«ì–´ >> í•´ê²° ë‹¨ìˆœ ì˜¤íƒ€ì˜€ìŒ



- cache ì—…ë°ì´íŠ¸ëŠ” ì•ˆí•˜ê³  ìˆìœ¼ë¯€ë¡œ reloadí•´ì•¼ ìƒˆ ë©”ì„¸ì§€ ë³´ì„

  - ğŸ’¦ë””ë¹„ì—ëŠ” ë“¤ì–´ê°”ëŠë° reloadí•´ë„ ì—…ë°ì´íŠ¸ì•ˆë¨...

    => ì¼ë‹¨ useEffect ì— refetch()  í•´ì„œ ë§ˆìš´íŠ¸ë ë•Œ refetchë˜ëŠ”ê±¸ë¡œ í•¨



- ìºì‹œ ì—…ë°ì´íŠ¸

  - í”„ë¡ íŠ¸ì—”ë“œë‘ ë˜‘ê°™ë‹¤ (ì½”ë©˜íŠ¸ ì˜¤ë¸Œì íŠ¸ ìœ„ì¡°í•´ì„œ ìºì‹œì— ë„£ê¸°)

  1. messageObj
     - ìœ„ì¡°í•˜ëŠ” message ê°ì²´ëŠ” messages ì•ˆì— ìˆëŠ” ê²ƒë“¤ê³¼ ë˜‘ê°™ì•„ì•¼ í•œë‹¤

  ```js
   const updateSendMessage = (cache, result) => {
          const { data: { sendMessage: { ok, id } } } = result;
  
          if (ok && meData) {
              const { message } = getValues();  // formì—ì„œ ì…ë ¥ë°›ì€ message
              const messageObj = {
                  id,
                  payload: message,
                  user: {
                      username: meData.me.username,
                      avatar: meData.me.avatar,
                  },
                  read: true,
                  __typename: "Message", // ìœ„ì¡°ì— í•„ìˆ˜ì„
              };
          }
      }
  const [sendMessageMutation, { loading: sendingMessage }] = useMutation(SEND_MESSAGE_MUTATION, {
          update: updateSendMessage,
      })
  ```

  2. messageFragment

  ```js
   const updateSendMessage = (cache, result) => {
       		...
              const messageFragment = cache.writeFragment({
                  fragment: gql`
                      fragment NewMessage on Message {
                          id
                          payload
                          user {
                              username
                              avatar
                          }
                          read
                      }
                  `,
                  data: messageObj,
              })
  ```

  3. modify cache

  ```js
  cache.modify({
                  id: `Room:${route.params.id}`,
                  fields: {
                      messages(prev){
                          return [messageFragment, ...prev]
                      }
                  }
              })
  ```

  


### #18.7 Room Screen part 5

- ì–´ë–¤ ì¿¼ë¦¬ë¥¼ ë¶€ë¥´ë“  í•­ìƒ idë¥¼ ê°€ì ¸ì˜¤ë©´ apolloê°€ ìë™ìœ¼ë¡œ ì¸ì‹í•¨

- ë©”ì„¸ì§€ ë³´ë‚¸ í›„ input ë¹„ìš°ê¸°
  - watch() ì‚¬ìš©í•˜ê¸° (ìºì‹œì— ë„£ì„ë•Œë§ˆë‹¤ "message" ê°’ ë¹„ìš°ê¸°)

```js
if (ok && meData) {
            const { message } = getValues();
            setValue("message", "");     // ì¶”ê°€
            const messageObj = {
                ...
                
...
<MessageInput
...
	value={watch("message")}
/>                
```

- ë°©ì— ë“¤ì–´ê°”ì„ë•Œ ê°€ì¥ ìµœê·¼ì˜ ë©”ì„¸ì§€ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°
  - ë‹¤ìŒ ê°•ì˜ì—ì„œ
