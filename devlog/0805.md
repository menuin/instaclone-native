# ğŸ‘» DEVLOG 8/5

### #17.10 Take Photo part 5

- ì‚¬ì§„ì°ê¸° => cacheì—ë§Œ ì €ì¥ë˜ê³ (ì¼ì‹œì ì €ì¥) íŒŒì¼ì‹œìŠ¤í…œì— ì €ì¥ë˜ê³  ìˆì§€ëŠ” x

- MediaLibrary ì´ìš©

1. createAssetAsync : uri ì¨ì¤˜ì•¼í•¨, asset ê°ì²´ ë°˜í™˜

```js
const assets = await MediaLibrary.createAssetAsync(uri);
```

2. saveToLibraryAsync : ì•„ë¬´ ê°ì²´ë„ ë°˜í™˜í•˜ì§€ x

- ì‚¬ì§„ ì €ì¥í•  í•„ìš”ì—†ì´ ë°”ë¡œ ì—…ë¡œë“œí•  ìˆ˜ë„ ìˆìŒ 	

- ë°©ê¸ˆ ì°ì€ ì‚¬ì§„ì„ í™”ë©´ì— ë„ìš°ê¸° (ê³  ì—…ë¡œë“œí•˜ê¸°)

  stateì‚¬ìš©í•´ì„œ takenPhotoê°€ ì¡´ì¬í•˜ë©´ ì‚¬ì§„ì„ ë„ìš°ê³ , ì•„ë‹ˆë©´ ì¹´ë©”ë¼ ì»´í¬ë„ŒíŠ¸ ë„ìš°ê¸°

```js
const [takenPhoto, setTakenPhoto] = useState("");

const takePhoto = async () => {
    ...
	setTakenPhoto(uri);
}

{takenPhoto === "" ? <Camera ì»´í¬ë„ŒíŠ¸> : <Image ì»´í¬ë„ŒíŠ¸>}
```

- Actions(Slider, takePhoto Button) ë„ ë§ˆì°¬ê°€ì§€ë¡œ í•˜ê¸°

```js
{takenPhoto === "" ? (Slider, takePhotoBtn) : (Dismiss, Upload, Save button)}
```



1. Dismiss

```js
const onDismiss = () => setTakenPhoto("");
```



### #17.11 Take Photo part 6

- Uploading Photo
- ë²„íŠ¼ ë‘ê°œ (dismiss, upload) ë¡œ í•˜ê³  uploadë¥¼ ëˆ„ë¥´ë©´ ì €ì¥í• ê±´ì§€ ë¬¼ì–´ë³´ëŠ” ê±¸ë¡œ ë³€ê²½

```js
    const onUpload = () => {
        Alert.alert("Alert", "Do you want to save before uploading?", 
            [  // array
            {
                text: "Yes",
                onPress: () => goToUpload(true),
            }, {
                text: "No, thanks",
                style: "destructive",   // ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œë¨
                onPress: () => goToUpload(false),
            }]);
    }
    
    
    const goToUpload = async (save) => {
        if (save) {
            // asset ê°ì²´ê°€ í•„ìš”ì—†ê¸° ë•Œë¬¸ì— saveToLibraryAsync ì‚¬ìš©
            await MediaLibrary.saveToLibraryAsync(takenPhoto);  // takenPhotoì— ë°©ê¸ˆ ì°ì€ ì‚¬ì§„ì˜ uri ì €ì¥ë˜ì–´ìˆìŒ
        }

    }
```



### #17.12 Upload Screen part 1

- minor bug : select photo ìŠ¤í¬ë¦°ì—ì„œë„ ì¹´ë©”ë¼ê°€ í•­ìƒ ì¼œì ¸ìˆìŒ / take photo í™”ë©´ì—ì„œ statusBar ë¥¼ ìˆ¨ê²¼ëŠ”ë° select photo í™”ë©´ì—ì„œë„ ìˆ¨ê²¨ì§

  - **focus** ì‚¬ìš©

  ```js
  // TakePhoto.js
  const isFocused = useIsFocused();
  
  {isFocused ? <StatusBar hidden={true} /> : null}
  // focused ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì—”(select photo screenì„ ë³´ê³  ìˆëŠ” ê²½ìš°) status bar ì„¤ì •ì´ nullì´ë¯€ë¡œ select photo ìŠ¤í¬ë¦°ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ
  ```

  

- upload screen : upload form ì„ ë³´ì—¬ì¤Œ
- ì¤‘ìš” : select photo í™”ë©´ì´ë‘ take photo í™”ë©´ì—ì„œ ë™ì‹œì— ê°™ì€ ìŠ¤í¬ë¦°ì„ ë³´ì—¬ì¤˜ì•¼í•¨

1. LoggedInNav ì— ìƒˆ ìŠ¤íƒ ìŠ¤í¬ë¦° ì¶”ê°€ (UploadForm)
2. selectPhoto ì—ì„œ navigate (next button)
   - ì„ íƒí•œ íŒŒì¼ì˜ uriì„ ê°€ì§€ê³  ê°€ì•¼í•¨
   - uploadForm ì˜ route.paramsë¡œ í™•ì¸

```js
<TouchableOpacity onPress={() => navigation.navigate("UploadForm", {
                file : chosenPhoto,
            })}>
```

3. takePhotoì—ì„œ navigate
   - ë°©ê¸ˆ ì°ì€ ì‚¬ì§„ì˜ uri ê°€ì§€ê³  ê°

```js
    const goToUpload = async (save) => {
        if (save) {
            await MediaLibrary.saveToLibraryAsync(takenPhoto);
        }
        navigation.navigate("UploadForm",{
            file : takenPhoto,
        });
    }
```

- uploadForm ìŠ¤í¬ë¦°ì—ë§Œ í—¤ë” ë„£ê¸°

```js
 <Stack.Navigator screenOptions={{ presentation: "modal" }}>
            <Stack.Screen name="Tabs" options={{ headerShown: false }} component={TabsNav} />
            <Stack.Screen name="Upload" options={{ headerShown: false }} component={UploadNav} />
                // ì–˜ë„¤ ë‘˜ë§Œ ì˜µì…˜ ì¤Œ
            <Stack.Screen name="UploadForm" component={UploadForm} />
        </Stack.Navigator>
```



### #17.13 Upload Screen part 2

- ì—ëŸ¬ : select photoì—ì„œ uploadForm ìŠ¤í¬ë¦°ìœ¼ë¡œ ë„˜ì–´ê°”ì„ë•Œ fileì´ empty stringì¸ ê²½ìš°

  => navigation.setOptionsê°€ ì»´í¬ë„ŒíŠ¸ê°€ mountë˜ì—ˆì„ë•Œ í•œë²ˆë§Œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ (ì´ë•ŒëŠ” ì„ íƒëœ ì‚¬ì§„ì´ ì—†ìœ¼ë‹ˆê¹Œ!)

  ```js
  useEffect(() => {
          navigation.setOptions({
              headerRight: HeaderRight,
          })
      }, [chosenPhoto]) // ì´ë ‡ê²Œí•´ì„œ ì‚¬ì§„ì„ ì„ íƒí•  ë•Œë§ˆë‹¤ re renderí•˜ê²Œ í•¨
  ```

- selectPhotoì—ì„œ HeaderRight ê°€ì ¸ë‹¤ ì“°ê¸° => ì»´í¬ë„ŒíŠ¸ë¡œ ë§Œë“œëŠ” ê²ƒ ê¶Œì¥

- ê¸°íƒ€ : ì½”ë“œ ì°¸ê³ 



### #17.14 Upload Screen part 3

- next ë²„íŠ¼ => uploadPhoto mutation ì‹¤í–‰ (ë’¤ë¡œ ê°€ê¸°ë²„íŠ¼ ì‚¬ë¼ì§€ê³  next=> loading ìœ¼ë¡œ ë°”ê¾¸ê¸°)

1. mutation ì‘ì„± (FEED_PHOTO fragment ì´ìš©)

2. ì‚¬ìš©

   - mutation loading ì¤‘ì¼ë•Œ í—¤ë” ë³€ê²½

   ```js
   const [uploadPhotoMutation, { loading }] = useMutation(UPLOAD_PHOTO_MUTATION);
   
   useEffect(() => {
           navigation.setOptions({
               headerRight: loading ? HeaderRightLoading : HeaderRight,
               ...(loading && { headerLeft: () => null }),
   
           })
       }, [loading])
   ```

   - onValid ì—ì„œ mutation ì‹¤í–‰ 
     - npm i apollo-upload-client

   ```js
   import { ReactNativeFile } from "apollo-upload-client";
   
   const onValid = ({ caption }) => {
           const file = new ReactNativeFile({
               uri: route.params.file,
               name : `1.jpg`,
               type : "image/jpeg"
           })
           uploadPhotoMutation({
               variables: {
                   caption,
                   file,
               }
           })
   ```

   ğŸ’¦ ì—ëŸ¬ : Response not successful : Received status code 400 (ë°±ì—”ë“œ resolverì— ê°€ì§€ë„ ëª»í•¨)

   - **Link** ì— ê´€í•œ ì´í•´

     - authLinkë³´ë‹¤ httpLinkê°€ ë¨¼ì € ì˜¤ëŠ” ì´ìœ :

     httpLinkëŠ” ì„œë²„ì— ë§ˆì§€ë§‰ìœ¼ë¡œ ìš”ì²­í•˜ëŠ”(ì¢…ë£Œë˜ëŠ”) linkì´ê¸°ë•Œë¬¸ì— httpLinkë¥¼ ê±°ì¹˜ê³  ë‚˜ì„œëŠ” ë‹¤ë¥¸ ì–´ë–¤ ì¼ë„ í•˜ë©´ ì•ˆë˜ê¸°ë•Œë¬¸

     ```js
     link: authLink.concat(httpLink),
     ```

   - onErrorLinkë¥¼ ë§Œë“¤ì–´ì„œ ì¤‘ê°„ì— ì—ëŸ¬ë¥¼ í™•ì¸í•´ë³´ì 

```js
import {onError} from "@apollo/client/link/error";

const onErrorLink = onError((error) => {
    console.log(error);
})
const client = new ApolloClient({
    link: authLink.concat(onErrorLink).concat(httpLink),
    cache,
})
```

- ì—ëŸ¬ : mutationì˜ variableë¡œ ì „ë‹¬í•œ fileê°’ì„ ì œëŒ€ë¡œ ëª» ì½ê³  ìˆìŒ (invalid)
- ReactNativeFileì„ ì‚¬ìš©í•˜ë©´ httpLink ê°€ ì´ íŒŒì¼ì„ ì–´ë–»ê²Œ ë‹¤ë¤„ì•¼í•˜ëŠ” ì§€ ëª°ë¼ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ => ë‹¤ìŒì‹œê°„ì— í•´ê²°



### #17.15 Upload Screen part 4

- createUploadLink ë§Œë“¤ê¸°
  - httpLinkë¥¼ uploadHttpLinkë¡œ ë³€ê²½í•˜ê¸°ë§Œ í•˜ë©´ ë¨

```js
const uploadHttpLink = createUploadLink({
    uri: "http://c26dbba746f4.ngrok.io/graphql",
})
...
link: authLink.concat(onErrorLink).concat(uploadHttpLink),
```

- â­â­ uploadí•œ ì´í›„ì— í”¼ë“œë°± (ìë™ìœ¼ë¡œ í”¼ë“œ ìƒˆë¡œê³ ì¹¨)
  - ì´ë²ˆì—ëŠ” cacheì— fake objectë¡œ ë§Œë“¤í•„ìš” ì—†ìŒ. (mutationì„ í†µí•´ ì´ë¯¸ cacheì— photo dataë¥¼ ê°€ì§€ê³  ìˆìŒ)
  - í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” commentë¥¼ ë§Œë“¤ë•Œ comment objectë¥¼ ë§Œë“¤ì–´ì•¼í–ˆëŠ”ë° ì—¬ê¸°ì„œëŠ” mutationì˜ ê²°ê³¼ë¡œ ëª¨ë“  photoë¥¼ ë°›ê¸°ë•Œë¬¸ì— (??)
  - íŠ¹ì • objectë¥¼ modifyí•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ root_queryë¥¼ modify

```js
const updateUploadPhoto = (cache, result) => {
        const { data: { uploadPhoto } } = result;
        if (uploadPhoto.id) {
            cache.modify({
                id: "ROOT_QUERY", // ëª¨ë“  ì¿¼ë¦¬ë°ì´í„°ê°€ ëª¨ì´ëŠ” ê³³
                fields: {
                    seeFeed(prev){
                        // ê¸°ì¡´ photo arrayì˜ ë§¨ ì•ì—ë‹¤ ë¶™ì„
                        return [uploadPhoto,...prev]
                    },
                }
            });
            navigation.navigate("Tabs"); // í”¼ë“œí™”ë©´ìœ¼ë¡œ ë˜ëŒë ¤ë³´ë‚´ê¸°
        }
    }
const [uploadPhotoMutation, { loading }] = useMutation(UPLOAD_PHOTO_MUTATION, {
        update : updateUploadPhoto,
    });

```



### #17.16 Conclusion

- í•´ì•¼í•  ê²ƒ : select photoì—ì„œ ê°¤ëŸ¬ë¦¬ì— ìˆëŠ” ì‚¬ì§„ infinite scroll êµ¬í˜„í•˜ê¸°



### #18.0 Message Navigator

- ë‹¤ì´ë ‰íŠ¸ ë©”ì„¸ì§€ ê¸°ëŠ¥ 

- FeedëŠ” sharedStackNavigator ì•ˆì— ìˆìœ¼ë‹ˆê°€ Stack.Screen optionì— ì¨ì¤˜ë„ ë¨
- navigation propì´ í•„ìš”í•˜ë‹ˆê¹Œ Feed.jsì•ˆì— ì‘ì„±

```js
  const MessagesBtn = () => {
    return (
      <TouchableOpacity style={{ marginRight: 15 }}>
        <Ionicons name="paper-plane" color="white" size={30} />
      </TouchableOpacity>)
  }

  useEffect(() => {
    navigation.setOptions({
      headerRight: MessagesBtn,

    })
  }, [])
```

ğŸ’¦ ê·¼ë° ì´ê²Œ í—¤ë” ë¡œê³  ì´ë¯¸ì§€ë‘ ê²¹ì³ì„œ ì•ˆë³´ì´ëŠ” ê²ƒ ê°™ìŒ (ë¡œê³  ì§€ìš°ë©´ ë³´ì„) => ì¼ë‹¨ ë¡œê³  ì§€ìš°ê³  í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´í•¨



- MessagesNav(ìŠ¤íƒ ë„¤ë¹„ê²Œì´í„°) => Rooms list(ìŠ¤íƒ ìŠ¤í¬ë¦°) , Room(ìŠ¤íƒ ìŠ¤í¬ë¦°)

```js
export default function MessagesNav() {
    return (
        <Stack.Navigator>
            <Stack.Screen name="Rooms" component={Rooms} />
            <Stack.Screen name="Room" component={Room} />
        </Stack.Navigator>
    )
}
```

```js
// LoggedInNav.js ì— ì¶”ê°€
<Stack.Screen
                name="Messages"
                component={MessagesNav}
                options={{ headerShown: false }}
            />
```

- ğŸ’¦ ìŠ¤íƒ ë„¤ë¹„ê²Œì´í„° ì•ˆì— ìŠ¤íƒ ë„¤ë¹„ê²Œì´í„°ê°€ ìˆì–´ì„œ í—¤ë”ê°€ ë‘ê°œê°€ ë¨ => headerShown : falseí•˜ë©´ Messages í—¤ë”ê°€ ì‚¬ë¼ì§€ê¸´í•˜ëŠ”ë° ìë¦¬ëŠ” ì°¨ì§€í•¨ (?) => selectPhoto ìœ„ì— í—¤ë” ìë¦¬ ë‚¨ëŠ” ë¬¸ì œë‘ ê°™ì€ ê²ƒ ê°™ìŒ (#17.8)
  - `        options={{ headerMode: "none" }}` í•˜ë©´ í—¤ë”ë¶€ë¶„ì´ í†µì§¸ë¡œ ë¹” (íˆ¬ëª…í•´ì§)
